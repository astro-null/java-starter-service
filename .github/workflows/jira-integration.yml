name: Jira Integration
# This workflow extracts Jira issue IDs from branch names, PR titles, or PR descriptions
# and updates issue status based on PR lifecycle events. Each step is self-contained for
# clarity and independent error handling.
# Extraction order: 1) Branch name, 2) PR title, 3) PR description

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  update-jira-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Extract Issue ID from Branch Name, PR Title, or PR Description
        id: extract-issue
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_DESCRIPTION="${{ github.event.pull_request.body }}"
          ISSUE_ID=""
          SOURCE=""

          # Try to extract issue ID (supports patterns like PROJ-123, ABC-456, etc.)
          # Pattern: [A-Z]+-[0-9]+

          # 1. Try branch name first
          echo "Checking branch name: $BRANCH_NAME"
          ISSUE_ID=$(echo "$BRANCH_NAME" | grep -oE '[A-Z]+-[0-9]+' | head -n 1 || echo "")
          if [ -n "$ISSUE_ID" ]; then
            SOURCE="branch name"
            echo "✓ Issue ID found in branch name: $ISSUE_ID"
          fi

          # 2. If not found, try PR title
          if [ -z "$ISSUE_ID" ]; then
            echo "No issue ID in branch name, checking PR title: $PR_TITLE"
            ISSUE_ID=$(echo "$PR_TITLE" | grep -oE '[A-Z]+-[0-9]+' | head -n 1 || echo "")
            if [ -n "$ISSUE_ID" ]; then
              SOURCE="PR title"
              echo "✓ Issue ID found in PR title: $ISSUE_ID"
            fi
          fi

          # 3. If still not found, try PR description
          if [ -z "$ISSUE_ID" ]; then
            echo "No issue ID in PR title, checking PR description"
            ISSUE_ID=$(echo "$PR_DESCRIPTION" | grep -oE '[A-Z]+-[0-9]+' | head -n 1 || echo "")
            if [ -n "$ISSUE_ID" ]; then
              SOURCE="PR description"
              echo "✓ Issue ID found in PR description: $ISSUE_ID"
            fi
          fi

          # Final check
          if [ -z "$ISSUE_ID" ]; then
            echo "✗ No issue ID found in branch name, PR title, or PR description. Skipping Jira integration."
            echo "issue_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "======================================"
          echo "Extracted Issue ID: $ISSUE_ID"
          echo "Source: $SOURCE"
          echo "======================================"
          echo "issue_id=$ISSUE_ID" >> $GITHUB_OUTPUT
          echo "issue_found=true" >> $GITHUB_OUTPUT

      - name: Update Jira Status to In Review
        if: |
          steps.extract-issue.outputs.issue_found == 'true' &&
          github.event.action != 'closed'
        continue-on-error: true
        run: |
          ISSUE_ID="${{ steps.extract-issue.outputs.issue_id }}"
          JIRA_BASE_URL="${{ secrets.JIRA_BASE_URL }}"
          JIRA_EMAIL="${{ secrets.JIRA_EMAIL }}"
          JIRA_API_TOKEN="${{ secrets.JIRA_API_TOKEN }}"

          if [ -z "$JIRA_BASE_URL" ] || [ -z "$JIRA_EMAIL" ] || [ -z "$JIRA_API_TOKEN" ]; then
            echo "Jira credentials not configured. Skipping status update."
            exit 0
          fi

          echo "Fetching available transitions for issue $ISSUE_ID..."

          # Get available transitions
          TRANSITIONS_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: application/json" \
            "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_ID/transitions")

          HTTP_CODE=$(echo "$TRANSITIONS_RESPONSE" | tail -n 1)
          TRANSITIONS_BODY=$(echo "$TRANSITIONS_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to fetch transitions. HTTP Status: $HTTP_CODE"
            echo "Response: $TRANSITIONS_BODY"
            exit 0
          fi

          echo "Available transitions:"
          echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | "\(.id): \(.name)"' || echo "Unable to parse transitions response"

          # Find "In Review" transition (case-insensitive search)
          TRANSITION_ID=$(echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | select(.name | test("in review"; "i")) | .id' | head -n 1)

          if [ -z "$TRANSITION_ID" ]; then
            echo "No 'In Review' transition found. Available transitions:"
            echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | .name' || echo "Unable to parse transitions"
            exit 0
          fi

          echo "Transitioning issue $ISSUE_ID to 'In Review' (transition ID: $TRANSITION_ID)..."

          # Update Jira issue status
          UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            -d "{\"transition\": {\"id\": \"$TRANSITION_ID\"}}" \
            "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_ID/transitions")

          UPDATE_HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n 1)
          UPDATE_BODY=$(echo "$UPDATE_RESPONSE" | sed '$d')

          if [ "$UPDATE_HTTP_CODE" -eq 204 ] || [ "$UPDATE_HTTP_CODE" -eq 200 ]; then
            echo "✅ Successfully updated Jira issue $ISSUE_ID to 'In Review'"
          else
            echo "Failed to update Jira issue. HTTP Status: $UPDATE_HTTP_CODE"
            echo "Response: $UPDATE_BODY"
          fi

      - name: Update Jira Status to Done
        if: |
          steps.extract-issue.outputs.issue_found == 'true' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == true &&
          github.event.pull_request.base.ref == 'main'
        continue-on-error: true
        run: |
          ISSUE_ID="${{ steps.extract-issue.outputs.issue_id }}"
          JIRA_BASE_URL="${{ secrets.JIRA_BASE_URL }}"
          JIRA_EMAIL="${{ secrets.JIRA_EMAIL }}"
          JIRA_API_TOKEN="${{ secrets.JIRA_API_TOKEN }}"

          if [ -z "$JIRA_BASE_URL" ] || [ -z "$JIRA_EMAIL" ] || [ -z "$JIRA_API_TOKEN" ]; then
            echo "Jira credentials not configured. Skipping status update."
            exit 0
          fi

          echo "Fetching available transitions for issue $ISSUE_ID..."

          # Get available transitions
          TRANSITIONS_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: application/json" \
            "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_ID/transitions")

          HTTP_CODE=$(echo "$TRANSITIONS_RESPONSE" | tail -n 1)
          TRANSITIONS_BODY=$(echo "$TRANSITIONS_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to fetch transitions. HTTP Status: $HTTP_CODE"
            echo "Response: $TRANSITIONS_BODY"
            exit 0
          fi

          echo "Available transitions:"
          echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | "\(.id): \(.name)"' || echo "Unable to parse transitions response"

          # Find "Done" transition (case-insensitive search)
          TRANSITION_ID=$(echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | select(.name | test("done"; "i")) | .id' | head -n 1)

          if [ -z "$TRANSITION_ID" ]; then
            echo "No 'Done' transition found. Available transitions:"
            echo "$TRANSITIONS_BODY" | jq -r '.transitions[] | .name' || echo "Unable to parse transitions"
            exit 0
          fi

          echo "Transitioning issue $ISSUE_ID to 'Done' (transition ID: $TRANSITION_ID)..."

          # Update Jira issue status
          UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            -d "{\"transition\": {\"id\": \"$TRANSITION_ID\"}}" \
            "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_ID/transitions")

          UPDATE_HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n 1)
          UPDATE_BODY=$(echo "$UPDATE_RESPONSE" | sed '$d')

          if [ "$UPDATE_HTTP_CODE" -eq 204 ] || [ "$UPDATE_HTTP_CODE" -eq 200 ]; then
            echo "✅ Successfully updated Jira issue $ISSUE_ID to 'Done'"
          else
            echo "Failed to update Jira issue. HTTP Status: $UPDATE_HTTP_CODE"
            echo "Response: $UPDATE_BODY"
          fi
